<?php

/**
 * This is a general Cms module object. All Cms modules should extend it.
 *
 * @package		Cms
 * @author		Matthias Mohr
 * @since 		1.0
 * @abstract
 */
abstract class CmsModuleObject extends ModuleObject {

	protected $breadcrumb;
	protected $cssFiles;
	protected $scriptFiles;
	protected $headHtml;

	public function __construct($package = 'Cms') {
		parent::__construct($package);

		$cache = Core::getObject('Core.Cache.CacheServer');
		$cache->setSourceDir('Cms.Cache.Items');

		// URL => content for media-attribute
		$this->cssFiles = array(
			URI::build('client/styles/stylesheet.css') => 'all'
		);

		// URL => content for type-attribute
		$cdn = Config::get('ui.jquery_cdn');
		$this->scriptFiles = array(
			URI::build($cdn ? $cdn : 'client/scripts/jquery/jquery.js') => 'text/javascript',
			URI::build('client/scripts/jquery/jquery.plugins.js') => 'text/javascript'
		);

		// Html to be placed into the head tag of the page (at last)
		$this->headHtml = array();

		Session::getObject(); // Init session

		$this->breadcrumb = new Breadcrumb();
		$this->breadcrumb->add(Config::get('general.title'), URI::frontPage());
	}

	public function __destruct() {
		try {
			Session::getObject()->update();
		} catch (QueryException $e) {
			Database::getObject()->getDebug()->add($e);
			throw $e;
		}
		parent::__destruct();
	}

	/**
	 * Default page
	 **/
	public function main() {
		$this->notFoundError();
	}

	/**
	 * Activates (and executes) the client form validation feature.
	 *
	 * This is an ajax based validation for form fields. The validation rules are based on the
	 * rules that are used to validate data using our Validator class.
	 *
	 * This has to be called before any output is generated by your scripts!
	 *
	 * Known issues:
	 * - COMPARE_EQUAL is not working
	 * - Validating reCaptcha should be avoided as the validation session ends
	 *
	 * @param array Validation settings
	 * @see Validator
	 */
	protected function enableClientFormValidation(&$options) {
		$ajax = Request::get('ajax');
		if (!empty($ajax)) {
			$this->executeClientFormValidation($options);
		}
		else {
			$tpl = Response::getObject()->getTemplate('/Cms/bits/client_validation');
			$tpl->assign('json', json_encode(array_keys($options)), false);
			$this->headHtml[] = $tpl->parse();
		}
	}

	protected function enableClientFormValidationOnError() {
		$ajax = Request::get('ajax');
		if (!empty($ajax)) {
			$this->sendJsonData(null);
		}
	}

	private function sendJsonData($data) {
		Response::getObject()->sendHeader('Content-Type: text/javascript; charset=utf8');
		echo json_encode($data);
		// Terminates the execution ot the script.
		// Shutdown functions and object destructors will always be executed.
		exit;
	}

	private function executeClientFormValidation(&$options) {
		$field = Request::get('ajax');
		$data = null;
		if (isset($options[$field])) {
			$result = Validator::checkRequest( array($field => $options[$field]) );

			$data = array(
				'valid' => count($result['error']) == 0,
				'field' => $field,
				'messages' => array()
			);
			foreach ($result['error'] as $error) {
				// Conversion to plain text and utf-8
				$data['messages'][] = html_entity_decode(htmlentities($error), ENT_QUOTES, 'UTF-8');
			}
		}
		$this->sendJsonData($data);
	}

	protected function header() {
		$tpl = Response::getObject()->appendTemplate('/Cms/header');
		$tpl->assign('breadcrumb', $this->breadcrumb, false);
		$tpl->assign('cssFiles', $this->cssFiles, false);
		$tpl->assign('scriptFiles', $this->scriptFiles, false);
		$tpl->assign('headHtml', implode(NL, $this->headHtml), false);
		$tpl->output();
	}

	protected function footer() {
		$tpl = Response::getObject()->appendTemplate('/Cms/footer');
		$tpl->assign('breadcrumb', $this->breadcrumb, false);
		$tpl->output();
	}

	protected function error($message, $url = null) {
		if (!is_array($message)) {
			$message = array($message);
		}
		$tpl = Response::getObject()->appendTemplate('/Cms/error');
		$tpl->assign('url', $url);
		$tpl->assign('message', $message);
		$tpl->output();
	}
	
	protected function notFoundError() {
		$this->header();
		$this->error('Die angeforderte Seite konnte leider nicht gefunden werden!');
		$this->footer();
	}

	protected function yesNo($question, $yesUrl, $noUrl) {
		$tpl = Response::getObject()->appendTemplate('/Cms/yes_no');
		$tpl->assign('yesUrl', $yesUrl);
		$tpl->assign('noUrl', $noUrl);
		$tpl->assign('question', $question);
		$tpl->output();
	}

	protected function notice($message) {
		$tpl = Response::getObject()->appendTemplate('/Cms/notice');
		$tpl->assign('message', $message);
		$tpl->output();
	}

	protected function ok($message, $url = null) {
		if (!is_array($message)) {
			$message = array($message);
		}
		$tpl = Response::getObject()->appendTemplate('/Cms/ok');
		$tpl->assign('url', $url);
		$tpl->assign('message', $message);
		$tpl->output();
	}

}
?>
